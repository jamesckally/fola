"use client";

import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { useSession } from "next-auth/react";
import { api } from "@/lib/api-client";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { ArrowUp, ArrowDown, Tag, PartyPopper, Copy } from "lucide-react";
import { toast } from "sonner";
import Image from "next/image";
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
} from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { BottomNav } from "@/components/BottomNav";

interface TokenBalance {
    token_type: string;
    balance: number;
}

const Dashboard = () => {
    const router = useRouter();
    const { data: session, status } = useSession();
    const [loading, setLoading] = useState(true);
    const [balances, setBalances] = useState<TokenBalance[]>([]);
    const [userTag, setUserTag] = useState<string | null>(null);
    const [countdown, setCountdown] = useState({ days: 5, hours: 0, minutes: 0, seconds: 0 });
    const [countdownEnded, setCountdownEnded] = useState(false);
    const [showConvertDialog, setShowConvertDialog] = useState(false);
    const [showCongratsDialog, setShowCongratsDialog] = useState(false);
    const [convertTxHash, setConvertTxHash] = useState("");
    const [converting, setConverting] = useState(false);

    const [endDate, setEndDate] = useState<Date | null>(null);

    useEffect(() => {
        if (status === "unauthenticated") {
            router.push("/auth");
        } else if (status === "authenticated") {
            // Check if user has a wallet
            // @ts-ignore
            if (!session?.user?.walletAddress) {
                router.push("/setup-wallet");
                return;
            }

            loadBalances();
            loadUserTag();
            initializeCountdown();
        }
    }, [status, session]);

    useEffect(() => {
        if (!endDate) return;

        const interval = setInterval(() => {
            const now = new Date().getTime();
            const distance = endDate.getTime() - now;

            if (distance <= 0) {
                setCountdownEnded(true);
                setCountdown({ days: 0, hours: 0, minutes: 0, seconds: 0 });
                clearInterval(interval);
            } else {
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                setCountdown({ days, hours, minutes, seconds });
            }
        }, 1000);

        return () => clearInterval(interval);
    }, [endDate]);

    const initializeCountdown = () => {
        const savedEndDate = localStorage.getItem("swapa_countdown_end");
        if (savedEndDate) {
            setEndDate(new Date(savedEndDate));
        } else {
            const end = new Date();
            end.setDate(end.getDate() + 5);
            localStorage.setItem("swapa_countdown_end", end.toISOString());
            setEndDate(end);
        }
    };

    const loadBalances = async () => {
        try {
            const data: any = await api.balances.getAll();
            setBalances(data || []);
        } catch (error) {
            console.error("Error loading balances:", error);
        } finally {
            setLoading(false);
        }
    };

    const loadUserTag = async () => {
        try {
            const data: any = await api.tags.get();
            if (data.tag_name) {
                setUserTag(data.tag_name);
            }
        } catch (error) {
            console.error("Error loading user tag:", error);
        }
    };

    const copyTagName = () => {
        if (userTag) {
            navigator.clipboard.writeText(userTag);
            toast.success("Tag name copied!");
        }
    };

    const getBalance = (tokenType: string) => {
        const balance = balances.find(b => b.token_type === tokenType);
        return balance?.balance || 0;
    };

    const handleConvertRewards = async () => {
        if (!convertTxHash) {
            toast.error("Please enter transaction hash");
            return;
        }

        setConverting(true);
        try {
            // Mock conversion - in production, this would be an API call
            await new Promise(resolve => setTimeout(resolve, 2000));

            setShowConvertDialog(false);
            setShowCongratsDialog(true);
            loadBalances();
            toast.success("Rewards converted successfully!");
        } catch (error: any) {
            toast.error(error.message || "Conversion failed");
        } finally {
            setConverting(false);
        }
    };

    const ccBalance = getBalance("CC");
    const rewardBalance = getBalance("REWARD_POINT");
    const usdtValue = (ccBalance * 0.08).toFixed(2);

    const PAYMENT_ADDRESS = "0xaa75beb862982fe138cec33c1e2b0d11d3466907";

    if (status === "loading" || loading) {
        return (
            <div className="flex items-center justify-center h-screen">
                <p className="text-muted-foreground">Loading...</p>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-background pb-20">
            <div className="w-full max-w-md mx-auto">
                {/* Header */}
                <div className="p-4 flex items-center justify-between border-b border-border">
                    <div className="flex items-center gap-2">
                        <div className="w-8 h-8 relative">
                            <Image
                                src="/logo.png"
                                alt="SwapaWallet Logo"
                                width={32}
                                height={32}
                                className="object-contain"
                            />
                        </div>
                        <span className="font-bold text-lg text-foreground">SwapaWallet</span>
                    </div>
                    <div className="flex items-center gap-2">
                        {userTag ? (
                            <button
                                onClick={copyTagName}
                                className="flex items-center gap-1 bg-primary/10 px-3 py-1.5 rounded-lg text-primary text-sm font-medium hover:bg-primary/20 transition-colors"
                            >
                                <span>{userTag}</span>
                                <Copy className="h-3 w-3" />
                            </button>
                        ) : (
                            <span className="text-xs text-muted-foreground">No tag</span>
                        )}
                    </div>
                </div>

                {/* Wallet Overview */}
                <div className="p-4">
                    <Card className="p-4 bg-card border-border">
                        <div className="flex items-center justify-between mb-2">
                            <span className="text-muted-foreground">Wallet overview</span>
                            <span className="text-sm text-primary">CC ${(ccBalance * 0.08).toFixed(4)}</span>
                        </div>
                        <div className="flex items-center justify-between">
                            <div>
                                <div className="text-3xl font-bold text-foreground mb-2">
                                    ${usdtValue}
                                </div>
                                <div className="flex items-center gap-2 text-success text-sm">
                                    <span>+7.30%</span>
                                    <span className="text-muted-foreground">24h</span>
                                </div>
                            </div>
                            <div className="text-right">
                                {countdownEnded ? (
                                    <Button
                                        onClick={() => setShowConvertDialog(true)}
                                        size="sm"
                                        className="bg-secondary hover:bg-secondary/90 text-secondary-foreground text-xs"
                                    >
                                        Convert
                                    </Button>
                                ) : (
                                    <div className="text-xs text-muted-foreground">
                                        <p className="mb-0.5">Time left</p>
                                        <p className="text-primary font-medium">
                                            {countdown.days}d {countdown.hours}h {countdown.minutes}m
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </Card>
                </div>

                {/* Quick Actions */}
                <div className="px-4 pb-4 space-y-3">
                    <div className="grid grid-cols-2 gap-3">
                        <Button
                            onClick={() => router.push("/send")}
                            className="bg-gradient-to-r from-primary to-primary/60 hover:opacity-90 text-primary-foreground h-10 py-1.5 rounded-full"
                        >
                            <ArrowUp className="mr-2 h-5 w-5" />
                            Send
                        </Button>
                        <Button
                            onClick={() => router.push("/receive")}
                            className="bg-gradient-to-r from-primary to-primary/60 hover:opacity-90 text-primary-foreground h-10 py-1.5 rounded-full"
                        >
                            <ArrowDown className="mr-2 h-5 w-5" />
                            Receive
                        </Button>
                    </div>
                    <Button
                        onClick={() => router.push("/tag")}
                        Enter your transaction hash to convert your rewards to CC.
                </DialogDescription>
            </DialogHeader>
            <div className="space-y-4 py-4">
                <div className="space-y-2">
                    <label className="text-sm font-medium">Payment Address</label>
                    <div className="bg-secondary/50 p-3 rounded-lg font-mono text-xs break-all flex items-center justify-between gap-2">
                        <span>{PAYMENT_ADDRESS}</span>
                        <Button
                            variant="ghost"
                            size="icon"
                            className="h-6 w-6"
                            onClick={() => {
                                navigator.clipboard.writeText(PAYMENT_ADDRESS);
                                toast.success("Address copied!");
                            }}
                        >
                            <Copy className="h-3 w-3" />
                        </Button>
                    </div>
                </div>
                <div className="space-y-2">
                    <label className="text-sm font-medium">Transaction Hash</label>
                    <Input
                        placeholder="0x..."
                        value={convertTxHash}
                        onChange={(e) => setConvertTxHash(e.target.value)}
                    />
                </div>
                <Button
                    onClick={handleConvertRewards}
                    className="w-full"
                    disabled={converting}
                >
                    {converting ? "Converting..." : "Confirm Conversion"}
                </Button>
            </div>
        </DialogContent>
                </Dialog >

    {/* Congrats Dialog */ }
    < Dialog open = { showCongratsDialog } onOpenChange = { setShowCongratsDialog } >
        <DialogContent className="sm:max-w-md">
            <div className="flex flex-col items-center text-center space-y-4 py-4">
                <div className="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center">
                    <PartyPopper className="h-8 w-8 text-primary" />
                </div>
                <DialogTitle className="text-2xl">Congratulations!</DialogTitle>
                <DialogDescription className="text-lg">
                    You have successfully converted your rewards to CC!
                </DialogDescription>
                <Button
                    onClick={() => setShowCongratsDialog(false)}
                    className="w-full"
                >
                    Awesome!
                </Button>
            </div>
        </DialogContent>
                </Dialog >
            </div >
    <BottomNav />
        </div >
    );
};

export default Dashboard;